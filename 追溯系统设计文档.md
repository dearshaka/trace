# 1 引言 #

## 1.1 编写目的 ##
本文档主要目的是说明产品追溯系统以下几点  

- 要解决的问题
- 系统总体实现方案
- 各模块的功能和关系  

## 1.2 产品追溯的概念 ##
产品追溯是指产品从制造、流通、消费到回收的整个生命周期过程中，利用标识技术记录和查询产品状态、属性、位置等信息的过程，其目的是全方位记录产品信息数据，促进企业内部信息系统之间、企业之间、企业和用户之间信息的有效共享，提高工业企业网络化、智能化水平。

## 1.3 术语定义及说明 ##
- 标识  
条形码、二维码、RFID 电子标签、智能 IC 卡、芯片等可以存储产品标识以及其它更加丰富的产品信息的实体
系统抽象为容器标识、单件标识、父标识

- 批次追溯  
追溯的对象按照批次的范围进行记录，若干零件共享一个标识，无法记录具体每个对象的信息

- 精确追溯  
追溯的每个对象均有唯一的身份标识，此标识随着生产进程不会发生变化
在某些场合可能发生标识一对一的替换或多对一的组装

- 追踪  
追溯查询的一种方式，从原料到成品方向的信息查询  
可以根据原材料或半成品，查找它们后续的去向，如加工的产品在哪个工序，发往哪个客户等  

- 溯源  
追溯查询的一种方式，从成品到原料的方向的信息查询  
可以根据成品，查找此成品完整的加工路径，每个加工过程使用的原材料、设备等信息  
可以根据中间的半成品，查找此半成品前面完整的加工路径。  

- 品质  
分为合格、不合格、报废3种状态


#2 需求分析 #
## 2.1 需求概述 ##
通过工厂现场的操作与追溯系统相结合，记录产品生产过程中的各种信息，并且支持通过标识、批次号、时间等不同的条件组合追溯查询已记录的历史信息。  
支持的追溯信息包含

 - 供应商信息
 - 制造过程中的5M1E信息
 - 出入库信息
 - 检验信息
 - 客户信息
 - 用户关心的其它信息
 
## 2.2 功能简介 ##

- 标识管理：标识的生成、拆分、合并等操作，标识分多种类型
- 加工管理：车间的投产、退料、批次生成、防错验证等
- 出入库：针对仓库的操作，如原料采购入库，半成品出入库，成品出库等
- 追溯分析：输入不同条件，查询对应产品在生产过程中记录的信息
- 基础数据管理：操作人员、设备、物料、工艺路线等基础信息的维护（由MES实现）
- 数据采集：加工过程中数据的采集，如设备参数，环境参数等（由IoT实现）

具体功能细节详见功能规格清单

## 2.3 条件与限制 ##
系统主要针对离散制造行业设计


# 3 总体设计 #

## 3.1 系统总体结构 ##
系统由业务模块和分析模块构成。业务模块依赖于MES进行基础数据管理与作业调度，依赖IoT进行生产数据采集与设备控制信号发送，并且提供标准HTTP接口供WMS、ERP等第三方系统调用。分析模块通过对业务系统记录的数据进行串联整合，实现产品信息追溯。  
系统整体逻辑架构图如下：
![](https://raw.githubusercontent.com/dearshaka/trace/master/system.png)

## 3.2 系统模块功能描述 ##
#### 业务功能 ####
1. 业务配置：工序设备配置、解析规则、批次生成规则、脚本管理等
- 标识生成：标识从0到1的过程，通过系统自身生成，存入数据库
- 标识解析：标识从0到1的过程，由系统解析外部标识，存入数据库
- 标识修改：数量修改、属性修改、标识清空等
- 标识转换：包含1：1、1：n、n：1等标识关系的转换
- 绑定解绑：父子标识的关系的绑定与解绑
- 标签打印：驱动标签打印机进行标签打印
- 投料：扫描标识进行投料
- 产出：扫描标识进行产出
- 退料：对剩余的投料进行退料
- 结转：A工单的剩余投料数转入B工单
- 可疑品登记：对可疑的物料进行登记，登记的物料可限制其流转
- 可疑品判定：对已登记的物料进行判定，解除可疑状态，根据不同的品质状态的决定如何继续流转
- 入库：扫描标识对物料进行入库操作，类型有原料入库、半成品入库、成品入库等
- 出库：扫描标识对物料进行出库操作，类型有原料出库、半成品出库、成品出库等
- 库存转储：物料在仓库间的转移
- 收发登记：物料到达工厂和产品离开工厂的动作登记

#### 分析功能 ####
1. 追踪查询：输入不同标识、物料、批次、设备、时间等条件，以某个工序为起点，往后查询相关产品的生产信息，需要提供产品分布报告
2. 溯源查询：输入不同标识、物料、批次、设备、时间等条件，以某个工序为起点，往前查询相关产品的生产信息
3. 履历查询：输入成品标识，以时间轴的方式显示该成品的生产信息
4. 出入库查询：输入标识、物料、批次等条件查询产品发往了哪里，主要针对成品发货

## 3.3 系统运行环境描述 ##
略


# 4 业务系统详细设计 #
## 4.1 投产扣减模型设计 ##
产品在工厂中根据一定的工艺路线经过多个工序进行加工。为了实现追溯，物料上需要赋予标识，并在加工过程中进行扫描。加工的大致过程是将由工人或机器将物料放入设备中（系统称之为投料），若干时间后，物料从设备中加工完成取出（系统称之为产出），或者物料从流水线流过，设备对其进行加工，加工完成后放行。这个过程投产的物料标识和形态都有可能发生变化，由于这些潜在的变化点存在，形成了每道工序有其各自的特点。此外物料产出的时候需要根据BOM比例去消耗投入的物料。基于以上，系统需要抽象一个投料产出的模型，用于适配不同的工序

#### 常见投产场景 ####

| 投料 | 产出 | 工序举例 |
|---  |---   | --- |
| 批物料 | 批物料 |熔炼、浇铸、热处理|
| 批物料 | 单件 |刻码|
| 单件 |单件 ||
| 单件 | 父容器 |装筐、装箱|
|批物料&单件|单件|装配|
| 父容器 | 父容器 ||

#### 扣减方案 ####
系统做了投料操作后，投料的数据会存在数据表中（系统称之为投料池），产出的时候需要根据规则去投料池寻找合适的数据进行扣减，寻找数据的过程可以分为数据行的定位与使用

**数据行定位**  
投料池有工单、标识、自定义属性等列，系统产出的时候先确定用于匹配扣减的数据，再用此数据根据配置去跟不同列进行匹配，匹配到的数据行就是参与扣减的数据  
**数据行使用**  
定位数据行后，则是对这些数据的使用，使用的方式根据不同的场景，可以抽象为先进先出、比例扣减、后进先出3种  
 
根据以上描述，在系统中增加**扣减方式**和**扣减边界**两个配置

- 扣减方式（单选）
  + 比例扣减
  + 先进先出
  + 后进先出 
 
- 扣减边界（单选) 
  + 工单
  + 标识
  + 父标识
  + 自定义属性

#### 案例 ####
1. 投批物料产批物料的普通离散工序，采用先进先出扣减，扣减的边界的是工单
2. 投批物料产批物料的成型工序，采用比例扣减，扣减的边界是工单
3. 单投单产的单件加工工序，采用后进先出，扣减边界是标识


## 4.2 物料流转记录设计 ##




## 4.3 集团化追溯设计 ##

。。

## 4.4 系统模块详细设计 ##
### 4.4.1 标识管理 ###
#### 模块描述 ####
产品追溯需要对生产加工信息进行记录并串联，信息载体是产品的身份标识，所以要对标识进行管理，具体功能有标识生成、标识解析、标识修改、标识转换、标识绑定解绑
#### 标识类型 ####
标识类型抽象为以下几类：

- 容器标识  
代表存放批量物料的容器，可能是小推车、筐子等，工厂内部赋码，可重复利用
- 单件标识  
代表单一实物，此标识在工厂内部管理体系中具有唯一性，且在流转过程中一般不发生变化，除了转码工序
- 父标识  
包含了若干子标识的标识类型，子标识可以是容器标识或单件标识，可多层嵌套
#### 标识生成 ####
标识生成分为两种。  
第一种是动态标识生成，在工序产出物料的时候使用，一般需要驱动打印，这种类型的标识生成规则可以选择上下文信息中的内容，可以在投产操作界面点击生成标识  
第二种是静态标识生成，在标识生成界面点击生成标识。适用于刚进工厂的物料没有标识，此时根据配置的规则生成标识贴在物料上使用。标识规则里一般需要配置流水号，系统需要记录各规则的最新流水号  
静态标识生成方式需要支持批量生成和带父子关系标识生成

- **输入** 
  - 动态标识生成：工序、设备信息
  - 静态标识生成：标识生成规则    
- **输出**  
  标识值列表
- **涉及接口**
 1. 动态标识生成
 2. 静态标识生成
 3. 标识规则列表查询
 4. 标识规则保存
 5. 基础属性与自定义属性查询
 6. 物料档案查询
 7. 供应商档案查询
 8. 客户档案查询

#### 标识解析 ####
工厂会有外部采购的原料和半成品，假如这些物料进厂时已带有标识，那么可通过标识解析功能将标识保存到系统数据库中   
不同的标识需要配置不同的解析规则，解析规则通过编写js脚本并存入数据库实现  
解析规则可多选，并有先后顺序之分。程序在解析时从上到下进行匹配，匹配到一个符合的规则后即退出

- **输入**   
标识
- **输出**  
解析结果
- **涉及接口**
 1. 标识解析
 2. 解析规则列表查询
 3. 解析规则脚本保存

#### 标识修改 ####
标识在工厂流转的过程中，会发生属性的变化。最常见的如对一个容器进行清空，则系统需要对该容器标识在数据库中的数量、物料、批次等属性值进行清除，清除后该容器视为空容器，理论上可以存放任何物料  
该功能不支持对标识进行批量操作
  
- **输入**   
标识、新的属性值
- **输出**  
修改结果
- **涉及接口**
 1. 标识信息保存
 2. 标识信息查询

#### 标识转换 ####
物料在工厂流转的过程中，会发生拆分和合并。比如容器筐A内的物料全部倒入容器筐B；容器筐A内的物料倒一半倒容器筐B，倒一半到容器筐C；
将容器筐B与容器筐C中物料并到容器筐A   
系统需要支持这种标识间数量转移，以上3个例子都属于源标识与目标标识间的数量转移，且分别代表了1:1、1：n、n：1三种关系    
该功能需要源标识与目标标识的某些属性一致，如物料、批次。不支持n：m关系多对多转移   
标识转换时需要记录物料流转记录
  
- **输入**   
源标识、目标标识、数量
- **输出**  
转换结果
- **涉及接口**
 1. 标识转换
 2. 标识信息查询

#### 绑定解绑 ####
标识有层级的概念，工厂业务中涉及修改父子关系的绑定关系，如从存有32个单件的箱子中，取出一个单件，此时系统需要解除这个单件与箱子的父子关系。相反的再放一个单件到箱子中，则需要建立该单件与箱子的关系  
该功能父标识只支持单选，仅支持父子两层关系的绑定与解绑
  
- **输入**   
父标识、子标识
- **输出**  
绑定解绑结果
- **涉及接口**
 1. 标识绑定解绑
 2. 标识信息查询

#### 标签打印 ####
某些场景需要直接驱动标签打印机进行标签打印，如包装工序，产出时自动打印箱标签，贴到箱子上  
该功能需要提前配置标签格式和标签数据

- **输入**   
标签打印规则
- **输出**  
打印结果
- **涉及接口**  
略

### 4.4.2 加工管理 ###
#### 模块描述 ####
产品在车间的加工过程涉及原料投入、辅料投入、半成品产出、半成品投料、产品产出等过程，系统需要记录过程中的数据。抽象后有投料、产出、退料、结转等动作和功能
#### 投料 ####
代表将物料投入到设备中进行加工  
操作步骤:扫描投料标识->输入投料数量->输入自定义属性（可选）->刷卡确认（可选）->按钮确定投料（可选）  
投料模式可分为扫码直投、刷卡确认、按钮确认   
提交投料信息需要支持记录自定义属性，需要记录物料流转记录
  
- **输入**   
投料标识、时间、人员、工单、投料数
- **输出**  
投料结果
- **涉及接口**
 1. 验证标识信息
 2. 投料确认
 3. 提交投料信息
 4. 投料信息查询

#### 产出 ####
代表物料从设备中加工完成   
操作步骤:扫描产出标识->选择品质->输入产出数量->输入自定义属性（可选）->刷卡确认（可选）->按钮确认产出（可选）  
产出模式可分为扫码直产、刷卡确认、按钮确认、产出自动投料   
提交产出信息需要支持记录自定义属性，需要记录物料流转记录   
自动化程度高的自动线需要支持产出自动投料
  
- **输入**   
产出标识、时间、人员、工单、品质、产出数、不良原因（可选）
- **输出**  
投料结果
- **涉及接口**
 1. 验证标识信息
 2. 产出确认
 3. 提交产出信息
 4. 产出自动投料
 5. 产出信息查询

#### 退料 ####
将剩余的已投物料退出设备   
操作步骤：选择或扫描已投物料标识->扫描目标标识(单件时可省略)->输入退料数量->输入退料原因（可选）->按钮确定退料   
退料模式可分为单件退单件、单件退父容器、容器退容器   
提交退料信息时需要记录物料流转记录
  
- **输入**   
待退物料标识、目标物料标识、时间、人员、工单、退料数量、退料原因（可选）
- **输出**  
退料结果
- **涉及接口**
 1. 验证标识信息
 2. 提交退料信息
 3. 可退信息查询
 4. 退料原因查询

#### 结转 ####
将剩余的已投物料从某一工单结转到另一工单，可以理解为先从工单退料，再去另一个工单投料 
操作步骤：选择源工单->选择目标工单->按钮确定退料    
提交结转信息时需要记录物料流转记录
  
- **输入**   
源工单、目标工单、时间
- **输出**  
结转结果
- **涉及接口**
 1. 提交结转信息
 2. 可结转物料查询
 3. 可结目标工单列表查询

### 4.4.3 出入库 ###
#### 模块描述 ####
产品在工厂中除了在车间还会在仓库中流转，出入库主要针对仓库流转这部分操作
#### 入库 ####
入库操作包含多种类型，可涉及多种仓库。常见的有原材料入库、半成品入库、成品入库、生产退料等  
该功能针对物料标识进行操作，数量为标识所含数量，不允许修改   
数据记录到出入库流水表

- **输入**   
物料标识、入库类型
- **输出**  
入库结果
- **涉及接口**
 1. 入库
 2. 入库类型查询
 3. 标识信息查询

#### 出库 ####
出库操作包含多种类型，可涉及多种仓库。常见的有销售出库、生产领料、半成品出库等  
该功能针对物料标识进行操作，数量为标识所含数量，不允许修改   
数据记录到出入库流水表

- **输入**   
物料标识、出库类型
- **输出**  
出库结果
- **涉及接口**
 1. 出库
 2. 出库类型查询
 3. 标识信息查询

#### 库存转储 ####
该功能是指将物料从仓库A转移到仓库B。操作时需要选择物料标识、源仓库、目标仓库   
数据记录到出入库流水表

- **输入**   
物料标识、源仓库、目标仓库
- **输出**  
转储结果
- **涉及接口**
 1. 库存转储
 2. 标识信息查询
 3. 仓库列表查询

#### 收发登记 ####
到货与发货的登记，可以视为产品在工厂流转的起点和终点   
对于未自带标识的原料可以通过此功能赋予身份标识   

- **输入**   
物料标识、物料、批次
- **输出**  
登记结果
- **涉及接口**
 1. 到货登记
 2. 发货登记
 3. 物料档案查询
 4. 标识信息查询
 5. 标识解析

### 4.4.4 可疑品处理 ###
#### 模块描述 ####
该模块主要针对工厂可疑品处理，主要包含可疑品登记和可疑品判定

#### 可疑品登记 ####
对可疑物料进行登记，登记为可疑品的物料可限制其流转   
可分为两种方式：一种是直接扫描标识进行登记，另一种是选择物料、批次、设备、时间段等作为起点，登记追踪后最新的数据

- **输入**   
物料标识、登记原因、物料、批次、设备、时间段
- **输出**  
登记结果
- **涉及接口**
 1. 可疑品登记
 2. 标识信息查询
 3. 物料档案查询
 4. 设备档案查询

#### 可疑品判定 ####
对已登记的可疑品进行判定，确定其品质后，再决定其流转方式，比如判定为合格的可以继续正常流转   
支持按某次登记数据整体判定、按标识单独判定、一键判定

- **输入**   
登记handle、物料标识
- **输出**  
判定结果
- **涉及接口**
 1. 可疑品判定
 2. 可疑品登记列表查询
 3. 标识信息查询

## 4.5 接口设计 ##
详见api文档


#5 分析系统详细设计 #
略


#6 数据库设计 #
详见数据库设计文档
